# map cookies/URIs in http context (these must be outside server{} but inside this file)
map $http_cookie $is_logged_in {
  default 0;
  "~wordpress_logged_in_" 1;
}

map $request_uri $is_public {
  default 0;
  ~^/wp-login\.php 1;
  ~^/wp-cron\.php 1;
  ~^/wp-json/ 1;
  ~^/wp-admin/admin-ajax\.php 1;
  ~^/wp-content/ 1;
  ~^/wp-includes/ 1;
}

# combine the two flags into one redirect decision
map "$is_logged_in:$is_public" $need_login_redirect {
  default 0;
  "0:0" 1;
}

server {
  listen 443 ssl;
  server_name _;

  ssl_certificate /run/secrets/tls_cert;
  ssl_certificate_key /run/secrets/tls_key;

  root /var/www/html;
  index index.php index.html;

  # redirect everybody who is not logged in to the WP login page
  location / {
    if ($need_login_redirect = 1) {
      return 302 https://$host/wp-login.php?redirect_to=$scheme://$host$request_uri;
    }

    try_files $uri $uri/ /index.php?$args;
  }

  location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff2?|ttf)$ {
    try_files $uri =404;
    access_log off;
    expires 30d;
  }


    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

     # ensure login and cron endpoints are handled by PHP
    location = /wp-login.php { include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_pass wordpress:9000; fastcgi_param HTTPS on; }
    location = /wp-cron.php  { include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_pass wordpress:9000; }
    location /wp-json/      { try_files $uri $uri/ /index.php?$args; }

    location ~ /\.ht {
        deny all;
    }
}